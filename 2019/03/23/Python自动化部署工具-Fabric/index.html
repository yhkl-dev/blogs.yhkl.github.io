<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="shortcut icon" href="/images/favicon.ico">
    
     
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet">
    
<link rel="stylesheet" href="/css/main.css">

    
    







    
    
          

    
    
    
    
    <title>
        
            Python自动化部署工具-Fabric | YHKL Blog
        
    </title>
    
    
<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    <div id="app">
        <v-app>
            <v-content id="page">
                <v-container fluid>
                    <v-row>
                        <v-col cols="2" class="d-none d-md-block">
                            <div id="sidebar" class="float-right">
    <a href="/" rel="home">
        <v-avatar size=96>
            <img id="logo" src="/images/avatar.webp">     
        </v-avatar> 
    </a>
    <v-divider></v-divider>
    <div class="mini-menu">
        <v-btn icon href="/">
            <v-icon>home</v-icon>
        </v-btn>
        <v-btn icon href="/categories/">
            <v-icon>folder</v-icon>
        </v-btn>
        <v-btn icon href="/tags/">
            <v-icon>bookmark</v-icon>
        </v-btn>
        <v-btn icon @click="SetNightMode">
            <v-icon>{{ nightMode }}</v-icon>
        </v-btn>
    </div>
    <v-list id="main-menu" class="font-weight-bold" flat>
        
            
            <v-list-item href="/" link>
            <v-list-item-icon><v-icon>home</v-icon></v-list-item-icon>
            <v-list-item-content>
                Index
            </v-list-item-content>
            </v-list-item>
        
            
            <v-list-item href="/archives/" link>
            <v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon>
            <v-list-item-content>
                Archives
            </v-list-item-content>
            </v-list-item>
        
            
            <v-list-item href="/about/" link>
            <v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon>
            <v-list-item-content>
                About
            </v-list-item-content>
            </v-list-item>
        
    </v-list>
    <v-divider></v-divider>
    
        <div class="post-toc">
            <a href="/2019/03/23/Python%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7-Fabric/" class="toc-header">Table of Contents</a>
            <div class="toc-content">
                <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#host-user-port"><span class="toc-number">1.</span> <span class="toc-text">host, user, port</span></a></li></ol>
            </div>
        </div>
    

    <div id="footer">
        <div class="footer-social">
            
                
                <v-btn icon href="mailto:kb1000fx@gmail.com" target="_blank">
                    <v-icon>fas fa-envelope</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://github.com/yhkl-dev" target="_blank">
                    <v-icon>fab fa-github</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://steamcommunity.com/profiles/76561198346798163" target="_blank">
                    <v-icon>fab fa-steam</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://weibo.com/kb1000fx" target="_blank">
                    <v-icon>fab fa-weibo</v-icon>
                </v-btn>
            
        </div>
        <v-divider></v-divider>
        <div class="footer-content">
            
                <span id="busuanzi_container_site_uv" style="display: none;"> 
                    Total Visitors <span id="busuanzi_value_site_uv"></span>
                </span>
                <br>
            
            <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a></span><br>
            <span>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
            <span>
                &copy; 2015 - 2021 
                yhkl
            </span>
        </div>
    </div>
</div>

                        </v-col>
                        <v-col cols="12" md="10">
                            <v-row>
  <v-col cols="12" md="8" align-self="end">
    <div id="site-header">
      <div id="site-title">
        <a href="/" rel="home">YHKL Blog</a>
      </div>
      <div id="site-description"></div>
      <div id="mobile-menu" class="d-block d-md-none">
        <v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,false)"></v-text-field>
        <div class="mobile-mini-menu">
          <v-btn icon href="/">
              <v-icon>home</v-icon>
          </v-btn>
          <v-btn icon href="/categories/">
              <v-icon>folder</v-icon>
          </v-btn>
          <v-btn icon href="/tags/">
              <v-icon>bookmark</v-icon>
          </v-btn>
          <v-btn icon @click="SetNightMode">
              <v-icon>{{ nightMode }}</v-icon>
          </v-btn>
          
            
            <v-btn icon href="/">
              <v-icon>home</v-icon>
            </v-btn>
          
            
            <v-btn icon href="/archives/">
              <v-icon>archive</v-icon>
            </v-btn>
          
            
            <v-btn icon href="/about/">
              <v-icon>account_circle</v-icon>
            </v-btn>
          
        </div>
      </div>    
    </div>
  </v-col>  
  <v-col cols="4" align-self="end" class="d-none d-md-block">
    <v-col align-self="end">
      <v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,false)"></v-text-field>
    </v-col> 
  </v-col>
</v-row>

                            <v-card class="elevation-2 post-card">
    
    
        <div class="post-header">
  <a class="post-header-title font-weight-medium" href="/2019/03/23/Python%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7-Fabric/">Python自动化部署工具-Fabric</a>
  <div class="post-header-meta">   
    <span>
      <v-icon color="">event</v-icon>
      Posted on:&nbsp;2019-03-23
    </span>
    <span>
      <v-icon color="">event_available</v-icon>
      Edited on:&nbsp;2021-10-30
    </span>
    <span>
      <v-icon color="">folder</v-icon>
      In:&nbsp;Uncategorized
    </span>
    
    <span>
      <v-icon color="">visibility</v-icon>
      Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
    </span>
    
  </div>
</div>

    
    
    
    
    <div class="post-content typo">
        <p>Fabric是python编写的一款自动化部署工具</p>
<p>Fabric依赖paramiko进行SSH交互，某种意义上Fabric是对paramiko的封装，封装完成后，不需要像使用paramiko一样处理SSH连接，只需专心于自己的需求即可。</p>
<p>Fabric的设计思路的是提供简单的API来完成所有部署，因此，Fabric对基本的系统管理操作进行了封装。</p>
<p>本篇文章主要针对Python3</p>
<p>fabric最常用的用法是通过SSH连接远程服务器执行Shell命令，然后拿到结果（可选），默认情况下，远程命令的输出直接被捕获并打印在终端上，以下为官网示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> fabric <span class="keyword">import</span> Connection</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Connection(<span class="string">&#x27;web1&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = c.run(<span class="string">&#x27;uname -s&#x27;</span>)</span><br><span class="line">Linux</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.stdout.strip() == <span class="string">&#x27;Linux&#x27;</span></span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.exited</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.ok</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.command</span><br><span class="line"><span class="string">&#x27;uname -s&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.connection</span><br><span class="line">&lt;Connection host=web1&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.connection.host</span><br><span class="line"><span class="string">&#x27;web1&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里遇到问题，安装上述方式并不能成功直接报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">46</span>]: c = Connection(<span class="string">&#x27;host2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">48</span>]: result = c.run(<span class="string">&quot;uname -s&quot;</span>)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">SSHException                              Traceback (most recent call last)</span><br><span class="line">&lt;ipython-<span class="built_in">input</span>-<span class="number">48</span>-688064d71ccd&gt; <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">----&gt; <span class="number">1</span> result = c.run(<span class="string">&quot;uname -s&quot;</span>)</span><br><span class="line"></span><br><span class="line">&lt;decorator-gen-<span class="number">3</span>&gt; <span class="keyword">in</span> run(self, command, **kwargs)</span><br><span class="line"></span><br><span class="line">/usr/python/lib/python3<span class="number">.7</span>/site-packages/fabric/connection.py <span class="keyword">in</span> opens(method, self, *args, **kwargs)</span><br><span class="line">     <span class="number">27</span> @decorator</span><br><span class="line">     <span class="number">28</span> <span class="function"><span class="keyword">def</span> <span class="title">opens</span>(<span class="params">method, self, *args, **kwargs</span>):</span></span><br><span class="line">---&gt; <span class="number">29</span>     self.<span class="built_in">open</span>()</span><br><span class="line">     <span class="number">30</span>     <span class="keyword">return</span> method(self, *args, **kwargs)</span><br><span class="line">     <span class="number">31</span></span><br><span class="line"></span><br><span class="line">/usr/python/lib/python3<span class="number">.7</span>/site-packages/fabric/connection.py <span class="keyword">in</span> <span class="built_in">open</span>(self)</span><br><span class="line">    <span class="number">613</span>             <span class="keyword">del</span> kwargs[<span class="string">&quot;key_filename&quot;</span>]</span><br><span class="line">    <span class="number">614</span>         <span class="comment"># Actually connect!</span></span><br><span class="line">--&gt; <span class="number">615</span>         self.client.connect(**kwargs)</span><br><span class="line">    <span class="number">616</span>         self.transport = self.client.get_transport()</span><br><span class="line">    <span class="number">617</span></span><br><span class="line"></span><br><span class="line">/usr/python/lib/python3<span class="number">.7</span>/site-packages/paramiko/client.py <span class="keyword">in</span> connect(self, hostname, port, username, password, pkey, key_filename, timeout, allow_agent, look_for_keys, compress, sock, gss_auth, gss_kex, gss_deleg_creds, gss_host, banner_timeout, auth_timeout, gss_trust_dns, passphrase)</span><br><span class="line">    <span class="number">435</span>             gss_deleg_creds,</span><br><span class="line">    <span class="number">436</span>             t.gss_host,</span><br><span class="line">--&gt; <span class="number">437</span>             passphrase,</span><br><span class="line">    <span class="number">438</span>         )</span><br><span class="line">    <span class="number">439</span></span><br><span class="line"></span><br><span class="line">/usr/python/lib/python3<span class="number">.7</span>/site-packages/paramiko/client.py <span class="keyword">in</span> _auth(self, username, password, pkey, key_filenames, allow_agent, look_for_keys, gss_auth, gss_kex, gss_deleg_creds, gss_host, passphrase)</span><br><span class="line">    <span class="number">748</span>         <span class="keyword">if</span> saved_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="number">749</span>             <span class="keyword">raise</span> saved_exception</span><br><span class="line">--&gt; <span class="number">750</span>         <span class="keyword">raise</span> SSHException(<span class="string">&quot;No authentication methods available&quot;</span>)</span><br><span class="line">    <span class="number">751</span></span><br><span class="line">    <span class="number">752</span>     <span class="function"><span class="keyword">def</span> <span class="title">_log</span>(<span class="params">self, level, msg</span>):</span></span><br><span class="line"></span><br><span class="line">SSHException: No authentication methods available</span><br></pre></td></tr></table></figure>

<p>查看fabric connection源码：</p>
<p>connection.py源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span>(<span class="params">Context</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A connection to an SSH daemon, with methods for commands and file transfer.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    **Basics**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This class inherits from Invoke&#x27;s `~invoke.context.Context`, as it is a</span></span><br><span class="line"><span class="string">    context within which commands, tasks etc can operate. It also encapsulates</span></span><br><span class="line"><span class="string">    a Paramiko `~paramiko.client.SSHClient` instance, performing useful high</span></span><br><span class="line"><span class="string">    level operations with that `~paramiko.client.SSHClient` and</span></span><br><span class="line"><span class="string">    `~paramiko.channel.Channel` instances generated from it.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    **Lifecycle**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    `.Connection` has a basic &quot;`create &lt;__init__&gt;`, `connect/open &lt;open&gt;`, `do</span></span><br><span class="line"><span class="string">    work &lt;run&gt;`, `disconnect/close &lt;close&gt;`&quot; lifecycle:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - `Instantiation &lt;__init__&gt;` imprints the object with its connection</span></span><br><span class="line"><span class="string">      parameters (but does **not** actually initiate the network connection).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        - An alternate constructor exists for users :ref:`upgrading piecemeal</span></span><br><span class="line"><span class="string">          from Fabric 1 &lt;from-v1&gt;`: `from_v1`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - Methods like `run`, `get` etc automatically trigger a call to</span></span><br><span class="line"><span class="string">      `open` if the connection is not active; users may of course call `open`</span></span><br><span class="line"><span class="string">      manually if desired.</span></span><br><span class="line"><span class="string">    - Connections do not always need to be explicitly closed; much of the</span></span><br><span class="line"><span class="string">      time, Paramiko&#x27;s garbage collection hooks or Python&#x27;s own shutdown</span></span><br><span class="line"><span class="string">      sequence will take care of things. **However**, should you encounter edge</span></span><br><span class="line"><span class="string">      cases (for example, sessions hanging on exit) it&#x27;s helpful to explicitly</span></span><br><span class="line"><span class="string">      close connections when you&#x27;re done with them.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      This can be accomplished by manually calling `close`, or by using the</span></span><br><span class="line"><span class="string">      object as a contextmanager::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        with Connection(&#x27;host&#x27;) as c:</span></span><br><span class="line"><span class="string">            c.run(&#x27;command&#x27;)</span></span><br><span class="line"><span class="string">            c.put(&#x27;file&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. note::</span></span><br><span class="line"><span class="string">        This class rebinds `invoke.context.Context.run` to `.local` so both</span></span><br><span class="line"><span class="string">        remote and local command execution can coexist.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    **Configuration**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Most `.Connection` parameters honor :doc:`Invoke-style configuration</span></span><br><span class="line"><span class="string">    &lt;/concepts/configuration&gt;` as well as any applicable :ref:`SSH config file</span></span><br><span class="line"><span class="string">    directives &lt;connection-ssh-config&gt;`. For example, to end up with a</span></span><br><span class="line"><span class="string">    connection to ``admin@myhost``, one could:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - Use any built-in config mechanism, such as ``/etc/fabric.yml``,</span></span><br><span class="line"><span class="string">      ``~/.fabric.json``, collection-driven configuration, env vars, etc,</span></span><br><span class="line"><span class="string">      stating ``user: admin`` (or ``&#123;&quot;user&quot;: &quot;admin&quot;&#125;``, depending on config</span></span><br><span class="line"><span class="string">      format.) Then ``Connection(&#x27;myhost&#x27;)`` would implicitly have a ``user``</span></span><br><span class="line"><span class="string">      of ``admin``.</span></span><br><span class="line"><span class="string">    - Use an SSH config file containing ``User admin`` within any applicable</span></span><br><span class="line"><span class="string">      ``Host`` header (``Host myhost``, ``Host *``, etc.) Again,</span></span><br><span class="line"><span class="string">      ``Connection(&#x27;myhost&#x27;)`` will default to an ``admin`` user.</span></span><br><span class="line"><span class="string">    - Leverage host-parameter shorthand (described in `.Config.__init__`), i.e.</span></span><br><span class="line"><span class="string">      ``Connection(&#x27;admin@myhost&#x27;)``.</span></span><br><span class="line"><span class="string">    - Give the parameter directly: ``Connection(&#x27;myhost&#x27;, user=&#x27;admin&#x27;)``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The same applies to agent forwarding, gateways, and so forth.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 2.0</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> these are initialized here to hint to invoke.Config.__setattr__</span></span><br><span class="line">    <span class="comment"># that they should be treated as real attributes instead of config proxies.</span></span><br><span class="line">    <span class="comment"># (Additionally, we&#x27;re doing this instead of using invoke.Config._set() so</span></span><br><span class="line">    <span class="comment"># we can take advantage of Sphinx&#x27;s attribute-doc-comment static analysis.)</span></span><br><span class="line">    <span class="comment"># Once an instance is created, these values will usually be non-None</span></span><br><span class="line">    <span class="comment"># because they default to the default config values.</span></span><br><span class="line">    host = <span class="literal">None</span></span><br><span class="line">    original_host = <span class="literal">None</span></span><br><span class="line">    user = <span class="literal">None</span></span><br><span class="line">    port = <span class="literal">None</span></span><br><span class="line">    ssh_config = <span class="literal">None</span></span><br><span class="line">    gateway = <span class="literal">None</span></span><br><span class="line">    forward_agent = <span class="literal">None</span></span><br><span class="line">    connect_timeout = <span class="literal">None</span></span><br><span class="line">    connect_kwargs = <span class="literal">None</span></span><br><span class="line">    client = <span class="literal">None</span></span><br><span class="line">    transport = <span class="literal">None</span></span><br><span class="line">    _sftp = <span class="literal">None</span></span><br><span class="line">    _agent_handler = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_v1</span>(<span class="params">cls, env, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Alternate constructor which uses Fabric 1&#x27;s ``env`` dict for settings.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        All keyword arguments besides ``env`` are passed unmolested into the</span></span><br><span class="line"><span class="string">        primary constructor.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. warning::</span></span><br><span class="line"><span class="string">            Because your own config overrides will win over data from ``env``,</span></span><br><span class="line"><span class="string">            make sure you only set values you *intend* to change from your v1</span></span><br><span class="line"><span class="string">            environment!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        For details on exactly which ``env`` vars are imported and what they</span></span><br><span class="line"><span class="string">        become in the new API, please see :ref:`v1-env-var-imports`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param env:</span></span><br><span class="line"><span class="string">            An explicit Fabric 1 ``env`` dict (technically, any</span></span><br><span class="line"><span class="string">            ``fabric.utils._AttributeDict`` instance should work) to pull</span></span><br><span class="line"><span class="string">            configuration from.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. versionadded:: 2.4</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> import fabric.state.env (need good way to test it first...)</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> how to handle somebody accidentally calling this in a process</span></span><br><span class="line">        <span class="comment"># where &#x27;fabric&#x27; is fabric 2, and there&#x27;s no fabric 1? Probably just a</span></span><br><span class="line">        <span class="comment"># re-raise of ImportError??</span></span><br><span class="line">        <span class="comment"># Our only requirement is a non-empty host_string</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> env.host_string:</span><br><span class="line">            <span class="keyword">raise</span> InvalidV1Env(</span><br><span class="line">                <span class="string">&quot;Supplied v1 env has an empty `host_string` value! Please make sure you&#x27;re calling Connection.from_v1 within a connected Fabric 1 session.&quot;</span>  <span class="comment"># noqa</span></span><br><span class="line">            )</span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> detect collisions with kwargs &amp; except instead of overwriting?</span></span><br><span class="line">        <span class="comment"># (More Zen of Python compliant, but also, effort, and also, makes it</span></span><br><span class="line">        <span class="comment"># harder for users to intentionally overwrite!)</span></span><br><span class="line">        connect_kwargs = kwargs.setdefault(<span class="string">&quot;connect_kwargs&quot;</span>, &#123;&#125;)</span><br><span class="line">        kwargs.setdefault(<span class="string">&quot;host&quot;</span>, env.host_string)</span><br><span class="line">        shorthand = derive_shorthand(env.host_string)</span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> don&#x27;t we need to do the below skipping for user too?</span></span><br><span class="line">        kwargs.setdefault(<span class="string">&quot;user&quot;</span>, env.user)</span><br><span class="line">        <span class="comment"># Skip port if host string seemed to have it; otherwise we hit our own</span></span><br><span class="line">        <span class="comment"># ambiguity clause in __init__. v1 would also have been doing this</span></span><br><span class="line">        <span class="comment"># anyways (host string wins over other settings).</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> shorthand[<span class="string">&quot;port&quot;</span>]:</span><br><span class="line">            <span class="comment"># Run port through int(); v1 inexplicably has a string default...</span></span><br><span class="line">            kwargs.setdefault(<span class="string">&quot;port&quot;</span>, <span class="built_in">int</span>(env.port))</span><br><span class="line">        <span class="comment"># key_filename defaults to None in v1, but in v2, we expect it to be</span></span><br><span class="line">        <span class="comment"># either unset, or set to a list. Thus, we only pull it over if it is</span></span><br><span class="line">        <span class="comment"># not None.</span></span><br><span class="line">        <span class="keyword">if</span> env.key_filename <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            connect_kwargs.setdefault(<span class="string">&quot;key_filename&quot;</span>, env.key_filename)</span><br><span class="line">        <span class="comment"># Obtain config values, if not given, from its own from_v1</span></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> not using setdefault as we truly only want to call</span></span><br><span class="line">        <span class="comment"># Config.from_v1 when necessary.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;config&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> kwargs:</span><br><span class="line">            kwargs[<span class="string">&quot;config&quot;</span>] = Config.from_v1(env)</span><br><span class="line">        <span class="keyword">return</span> cls(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> should &quot;reopening&quot; an existing Connection object that has been</span></span><br><span class="line">    <span class="comment"># closed, be allowed? (See e.g. how v1 detects closed/semi-closed</span></span><br><span class="line">    <span class="comment"># connections &amp; nukes them before creating a new client to the same host.)</span></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> push some of this into paramiko.client.Client? e.g. expand what</span></span><br><span class="line">    <span class="comment"># Client.exec_command does, it already allows configuring a subset of what</span></span><br><span class="line">    <span class="comment"># we do / will eventually do / did in 1.x. It&#x27;s silly to have to do</span></span><br><span class="line">    <span class="comment"># .get_transport().open_session().</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        host,</span></span></span><br><span class="line"><span class="params"><span class="function">        user=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        port=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        config=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        gateway=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        forward_agent=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        connect_timeout=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        connect_kwargs=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        inline_ssh_env=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Set up a new object representing a server connection.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param str host:</span></span><br><span class="line"><span class="string">            the hostname (or IP address) of this connection.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            May include shorthand for the ``user`` and/or ``port`` parameters,</span></span><br><span class="line"><span class="string">            of the form ``user@host``, ``host:port``, or ``user@host:port``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            .. note::</span></span><br><span class="line"><span class="string">                Due to ambiguity, IPv6 host addresses are incompatible with the</span></span><br><span class="line"><span class="string">                ``host:port`` shorthand (though ``user@host`` will still work</span></span><br><span class="line"><span class="string">                OK). In other words, the presence of &gt;1 ``:`` character will</span></span><br><span class="line"><span class="string">                prevent any attempt to derive a shorthand port number; use the</span></span><br><span class="line"><span class="string">                explicit ``port`` parameter instead.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            .. note::</span></span><br><span class="line"><span class="string">                If ``host`` matches a ``Host`` clause in loaded SSH config</span></span><br><span class="line"><span class="string">                data, and that ``Host`` clause contains a ``Hostname``</span></span><br><span class="line"><span class="string">                directive, the resulting `.Connection` object will behave as if</span></span><br><span class="line"><span class="string">                ``host`` is equal to that ``Hostname`` value.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                In all cases, the original value of ``host`` is preserved as</span></span><br><span class="line"><span class="string">                the ``original_host`` attribute.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                Thus, given SSH config like so::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    Host myalias</span></span><br><span class="line"><span class="string">                        Hostname realhostname</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                a call like ``Connection(host=&#x27;myalias&#x27;)`` will result in an</span></span><br><span class="line"><span class="string">                object whose ``host`` attribute is ``realhostname``, and whose</span></span><br><span class="line"><span class="string">                ``original_host`` attribute is ``myalias``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param str user:</span></span><br><span class="line"><span class="string">            the login user for the remote connection. Defaults to</span></span><br><span class="line"><span class="string">            ``config.user``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param int port:</span></span><br><span class="line"><span class="string">            the remote port. Defaults to ``config.port``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param config:</span></span><br><span class="line"><span class="string">            configuration settings to use when executing methods on this</span></span><br><span class="line"><span class="string">            `.Connection` (e.g. default SSH port and so forth).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            Should be a `.Config` or an `invoke.config.Config`</span></span><br><span class="line"><span class="string">            (which will be turned into a `.Config`).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            Default is an anonymous `.Config` object.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param gateway:</span></span><br><span class="line"><span class="string">            An object to use as a proxy or gateway for this connection.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            This parameter accepts one of the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            - another `.Connection` (for a ``ProxyJump`` style gateway);</span></span><br><span class="line"><span class="string">            - a shell command string (for a ``ProxyCommand`` style style</span></span><br><span class="line"><span class="string">              gateway).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            Default: ``None``, meaning no gatewaying will occur (unless</span></span><br><span class="line"><span class="string">            otherwise configured; if one wants to override a configured gateway</span></span><br><span class="line"><span class="string">            at runtime, specify ``gateway=False``.)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            .. seealso:: :ref:`ssh-gateways`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param bool forward_agent:</span></span><br><span class="line"><span class="string">            Whether to enable SSH agent forwarding.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            Default: ``config.forward_agent``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param int connect_timeout:</span></span><br><span class="line"><span class="string">            Connection timeout, in seconds.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            Default: ``config.timeouts.connect``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param dict connect_kwargs:</span></span><br><span class="line"><span class="string">            Keyword arguments handed verbatim to</span></span><br><span class="line"><span class="string">            `SSHClient.connect &lt;paramiko.client.SSHClient.connect&gt;` (when</span></span><br><span class="line"><span class="string">            `.open` is called).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            `.Connection` tries not to grow additional settings/kwargs of its</span></span><br><span class="line"><span class="string">            own unless it is adding value of some kind; thus,</span></span><br><span class="line"><span class="string">            ``connect_kwargs`` is currently the right place to hand in</span></span><br><span class="line"><span class="string">            parameters such as ``pkey`` or ``key_filename``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            Default: ``config.connect_kwargs``.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param bool inline_ssh_env:</span></span><br><span class="line"><span class="string">            Whether to send environment variables &quot;inline&quot; as prefixes in front</span></span><br><span class="line"><span class="string">            of command strings (``export VARNAME=value &amp;&amp; mycommand here``),</span></span><br><span class="line"><span class="string">            instead of trying to submit them through the SSH protocol itself</span></span><br><span class="line"><span class="string">            (which is the default behavior). This is necessary if the remote</span></span><br><span class="line"><span class="string">            server has a restricted ``AcceptEnv`` setting (which is the common</span></span><br><span class="line"><span class="string">            default).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            The default value is the value of the ``inline_ssh_env``</span></span><br><span class="line"><span class="string">            :ref:`configuration value &lt;default-values&gt;` (which itself defaults</span></span><br><span class="line"><span class="string">            to ``False``).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            .. warning::</span></span><br><span class="line"><span class="string">                This functionality does **not** currently perform any shell</span></span><br><span class="line"><span class="string">                escaping on your behalf! Be careful when using nontrivial</span></span><br><span class="line"><span class="string">                values, and note that you can put in your own quoting,</span></span><br><span class="line"><span class="string">                backslashing etc if desired.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                Consider using a different approach (such as actual</span></span><br><span class="line"><span class="string">                remote shell scripts) if you run into too many issues here.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            .. note::</span></span><br><span class="line"><span class="string">                When serializing into prefixed ``FOO=bar`` format, we apply the</span></span><br><span class="line"><span class="string">                builtin `sorted` function to the env dictionary&#x27;s keys, to</span></span><br><span class="line"><span class="string">                remove what would otherwise be ambiguous/arbitrary ordering.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            .. note::</span></span><br><span class="line"><span class="string">                This setting has no bearing on *local* shell commands; it only</span></span><br><span class="line"><span class="string">                affects remote commands, and thus, methods like `.run` and</span></span><br><span class="line"><span class="string">                `.sudo`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :raises ValueError:</span></span><br><span class="line"><span class="string">            if user or port values are given via both ``host`` shorthand *and*</span></span><br><span class="line"><span class="string">            their own arguments. (We `refuse the temptation to guess`_).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. _refuse the temptation to guess:</span></span><br><span class="line"><span class="string">            http://zen-of-python.info/</span></span><br><span class="line"><span class="string">            in-the-face-of-ambiguity-refuse-the-temptation-to-guess.html#12</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. versionchanged:: 2.3</span></span><br><span class="line"><span class="string">            Added the ``inline_ssh_env`` parameter.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> parent __init__ sets self._config; for now we simply overwrite</span></span><br><span class="line">        <span class="comment"># that below. If it&#x27;s somehow problematic we would want to break parent</span></span><br><span class="line">        <span class="comment"># __init__ up in a manner that is more cleanly overrideable.</span></span><br><span class="line">        <span class="built_in">super</span>(Connection, self).__init__(config=config)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#: The .Config object referenced when handling default values (for e.g.</span></span><br><span class="line">        <span class="comment">#: user or port, when not explicitly given) or deciding how to behave.</span></span><br><span class="line">        <span class="keyword">if</span> config <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            config = Config()</span><br><span class="line">        <span class="comment"># Handle &#x27;vanilla&#x27; Invoke config objects, which need cloning &#x27;into&#x27; one</span></span><br><span class="line">        <span class="comment"># of our own Configs (which grants the new defaults, etc, while not</span></span><br><span class="line">        <span class="comment"># squashing them if the Invoke-level config already accounted for them)</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(config, Config):</span><br><span class="line">            config = config.clone(into=Config)</span><br><span class="line">        self._<span class="built_in">set</span>(_config=config)</span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> when/how to run load_files, merge, load_shell_env, etc?</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> i.e. what is the lib use case here (and honestly in invoke too)</span></span><br><span class="line"></span><br><span class="line">        shorthand = self.derive_shorthand(host)</span><br><span class="line">        host = shorthand[<span class="string">&quot;host&quot;</span>]</span><br><span class="line">        err = <span class="string">&quot;You supplied the &#123;&#125; via both shorthand and kwarg! Please pick one.&quot;</span>  <span class="comment"># noqa</span></span><br><span class="line">        <span class="keyword">if</span> shorthand[<span class="string">&quot;user&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(err.<span class="built_in">format</span>(<span class="string">&quot;user&quot;</span>))</span><br><span class="line">            user = shorthand[<span class="string">&quot;user&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> shorthand[<span class="string">&quot;port&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> port <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(err.<span class="built_in">format</span>(<span class="string">&quot;port&quot;</span>))</span><br><span class="line">            port = shorthand[<span class="string">&quot;port&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> we load SSH config data as early as possible as it has</span></span><br><span class="line">        <span class="comment"># potential to affect nearly every other attribute.</span></span><br><span class="line">        <span class="comment">#: The per-host SSH config data, if any. (See :ref:`ssh-config`.)</span></span><br><span class="line">        self.ssh_config = self.config.base_ssh_config.lookup(host)</span><br><span class="line"></span><br><span class="line">        self.original_host = host</span><br><span class="line">        <span class="comment">#: The hostname of the target server.</span></span><br><span class="line">        self.host = host</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;hostname&quot;</span> <span class="keyword">in</span> self.ssh_config:</span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> log that this occurred?</span></span><br><span class="line">            self.host = self.ssh_config[<span class="string">&quot;hostname&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment">#: The username this connection will use to connect to the remote end.</span></span><br><span class="line">        self.user = user <span class="keyword">or</span> self.ssh_config.get(<span class="string">&quot;user&quot;</span>, self.config.user)</span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> is it _ever_ possible to give an empty user value (e.g.</span></span><br><span class="line">        <span class="comment"># user=&#x27;&#x27;)? E.g. do some SSH server specs allow for that?</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#: The network port to connect on.</span></span><br><span class="line">        self.port = port <span class="keyword">or</span> <span class="built_in">int</span>(self.ssh_config.get(<span class="string">&quot;port&quot;</span>, self.config.port))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Gateway/proxy/bastion/jump setting: non-None values - string,</span></span><br><span class="line">        <span class="comment"># Connection, even eg False - get set directly; None triggers seek in</span></span><br><span class="line">        <span class="comment"># config/ssh_config</span></span><br><span class="line">        <span class="comment">#: The gateway `.Connection` or ``ProxyCommand`` string to be used,</span></span><br><span class="line">        <span class="comment">#: if any.</span></span><br><span class="line">        self.gateway = gateway <span class="keyword">if</span> gateway <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> self.get_gateway()</span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> we use string above, vs ProxyCommand obj, to avoid spinning up</span></span><br><span class="line">        <span class="comment"># the ProxyCommand subprocess at init time, vs open() time.</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> make paramiko.proxy.ProxyCommand lazy instead?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> forward_agent <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># Default to config...</span></span><br><span class="line">            forward_agent = self.config.forward_agent</span><br><span class="line">            <span class="comment"># But if ssh_config is present, it wins</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;forwardagent&quot;</span> <span class="keyword">in</span> self.ssh_config:</span><br><span class="line">                <span class="comment"># <span class="doctag">TODO:</span> SSHConfig really, seriously needs some love here, god</span></span><br><span class="line">                map_ = &#123;<span class="string">&quot;yes&quot;</span>: <span class="literal">True</span>, <span class="string">&quot;no&quot;</span>: <span class="literal">False</span>&#125;</span><br><span class="line">                forward_agent = map_[self.ssh_config[<span class="string">&quot;forwardagent&quot;</span>]]</span><br><span class="line">        <span class="comment">#: Whether agent forwarding is enabled.</span></span><br><span class="line">        self.forward_agent = forward_agent</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> connect_timeout <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            connect_timeout = self.ssh_config.get(</span><br><span class="line">                <span class="string">&quot;connecttimeout&quot;</span>, self.config.timeouts.connect</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">if</span> connect_timeout <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            connect_timeout = <span class="built_in">int</span>(connect_timeout)</span><br><span class="line">        <span class="comment">#: Connection timeout</span></span><br><span class="line">        self.connect_timeout = connect_timeout</span><br><span class="line"></span><br><span class="line">        <span class="comment">#: Keyword arguments given to `paramiko.client.SSHClient.connect` when</span></span><br><span class="line">        <span class="comment">#: `open` is called.</span></span><br><span class="line">        self.connect_kwargs = self.resolve_connect_kwargs(connect_kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#: The `paramiko.client.SSHClient` instance this connection wraps.</span></span><br><span class="line">        client = SSHClient()</span><br><span class="line">        client.set_missing_host_key_policy(AutoAddPolicy())</span><br><span class="line">        self.client = client</span><br><span class="line"></span><br><span class="line">        <span class="comment">#: A convenience handle onto the return value of</span></span><br><span class="line">        <span class="comment">#: ``self.client.get_transport()``.</span></span><br><span class="line">        self.transport = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> inline_ssh_env <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            inline_ssh_env = self.config.inline_ssh_env</span><br><span class="line">        <span class="comment">#: Whether to construct remote command lines with env vars prefixed</span></span><br><span class="line">        <span class="comment">#: inline.</span></span><br><span class="line">        self.inline_ssh_env = inline_ssh_env</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>connection 成员变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">host = None             # 主机名或IP地址: www.host.com, 66.66.66.66</span><br><span class="line">original_host = None    # 同host</span><br><span class="line">user = None             # 系统用户名: root, someone</span><br><span class="line">port = None             # 端口号（远程执行某些应用需提供）</span><br><span class="line">gateway = None          # 网关</span><br><span class="line">forward_agent = None    # 代理</span><br><span class="line">connect_timeout = None  # 超时时间</span><br><span class="line">connect_kwargs = None   # 连接参数 重要</span><br><span class="line">client = None           # 客户端</span><br></pre></td></tr></table></figure>

<p>构造函数参数：</p>
<p>Connection.<strong>init</strong>()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">host</span><br><span class="line">user=<span class="literal">None</span></span><br><span class="line">port=<span class="literal">None</span></span><br><span class="line">config=<span class="literal">None</span></span><br><span class="line">gateway=<span class="literal">None</span></span><br><span class="line">forward_agent=<span class="literal">None</span></span><br><span class="line">connect_timeout=<span class="literal">None</span></span><br><span class="line">connect_kwargs=<span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>这里比较重要的参数是 <code>config</code>和 <code>connection_kwargs</code></p>
<p>构造函数主体：</p>
<p><strong>config</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">super</span>(Connection, self).__init__(config=config)</span><br><span class="line"><span class="keyword">if</span> config <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    config = Config()</span><br><span class="line"><span class="keyword">elif</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(config, Config):</span><br><span class="line">    config = config.clone(into=Config)</span><br><span class="line">self._<span class="built_in">set</span>(_config=config)</span><br><span class="line"></span><br><span class="line">Connection.__init__()</span><br></pre></td></tr></table></figure>

<p><code>config</code>成员变量是一个 <code>Config</code>对象，它是调用父类 <code>Context.__init__()</code>方法来初始化的。 <code>Context.__init__()</code>定义如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span>(<span class="params">DataProxy</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, config=<span class="literal">None</span></span>):</span></span><br><span class="line">        config = config <span class="keyword">if</span> config <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> Config()</span><br><span class="line">        self._<span class="built_in">set</span>(_config=config)</span><br><span class="line"></span><br><span class="line">        command_prefixes = <span class="built_in">list</span>()</span><br><span class="line">        self._<span class="built_in">set</span>(command_prefixes=command_prefixes)</span><br><span class="line"></span><br><span class="line">        command_cwds = <span class="built_in">list</span>()</span><br><span class="line">        self._<span class="built_in">set</span>(command_cwds=command_cwds)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span></span></span><br></pre></td></tr></table></figure>

<p>具体过程是 <code>Context.__init__()</code>初始化时调用 <code>_set()</code>绑定了 <code>Config</code>成员对象 <code>_config</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_set</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> args:</span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, *args)</span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> six.iteritems(kwargs):</span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, key, value)</span><br></pre></td></tr></table></figure>

<p>再通过加了 <code>@property</code>的 <code>config()</code>函数，使得 <code>connection</code>对象能直接用 <code>self.config</code>来引用 <code>_config</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">config</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self._config</span><br><span class="line"></span><br><span class="line"><span class="meta">@config.setter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">config</span>(<span class="params">self, value</span>):</span></span><br><span class="line">    self._<span class="built_in">set</span>(_config=value)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataProxy</span></span></span><br></pre></td></tr></table></figure>

<h5 id="host-user-port"><a href="#host-user-port" class="headerlink" title="host, user, port"></a>host, user, port</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">shorthand = self.derive_shorthand(host)</span><br><span class="line">host = shorthand[<span class="string">&quot;host&quot;</span>]</span><br><span class="line">err = (</span><br><span class="line">    <span class="string">&quot;You supplied the &#123;&#125; via both shorthand and kwarg! Please pick one.&quot;</span>  <span class="comment"># noqa</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> shorthand[<span class="string">&quot;user&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(err.<span class="built_in">format</span>(<span class="string">&quot;user&quot;</span>))</span><br><span class="line">    user = shorthand[<span class="string">&quot;user&quot;</span>]</span><br><span class="line"><span class="keyword">if</span> shorthand[<span class="string">&quot;port&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">if</span> port <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(err.<span class="built_in">format</span>(<span class="string">&quot;port&quot;</span>))</span><br><span class="line">    port = shorthand[<span class="string">&quot;port&quot;</span>]</span><br><span class="line"></span><br><span class="line">Connection.__init__()</span><br></pre></td></tr></table></figure>

<p>这里是处理host参数的， host可以有一下几种传参形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@host:port  # 例如: root@10.10.10.10:6666</span><br><span class="line">user@host       # 例如: root@10.10.10.10</span><br><span class="line">host:port       # 例如: 10.10.10.10:6666</span><br><span class="line">host            # 例如: 10.10.10.10</span><br></pre></td></tr></table></figure>

<p>前三种会调用 <code>self.derive_shorthand(host)</code>分别解析出 <code>self.host</code>， <code>self.user</code>和 <code>self.port</code>，最后一种需单独传入 <code>user</code>，<code>port</code>。<br>如果用前三种传入方式的话，不能再重复传入 <code>user</code>或 <code>port</code>了，会抛出异常</p>
<p>以上分析</p>
<p>定位报错位置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kwargs = <span class="built_in">dict</span>(</span><br><span class="line">    self.connect_kwargs,</span><br><span class="line">    username=self.user,</span><br><span class="line">    hostname=self.host,</span><br><span class="line">    port=self.port,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> self.gateway:</span><br><span class="line">    kwargs[<span class="string">&quot;sock&quot;</span>] = self.open_gateway()</span><br><span class="line"><span class="keyword">if</span> self.connect_timeout:</span><br><span class="line">    kwargs[<span class="string">&quot;timeout&quot;</span>] = self.connect_timeout</span><br><span class="line"><span class="comment"># Strip out empty defaults for less noisy debugging</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;key_filename&quot;</span> <span class="keyword">in</span> kwargs <span class="keyword">and</span> <span class="keyword">not</span> kwargs[<span class="string">&quot;key_filename&quot;</span>]:</span><br><span class="line">    <span class="keyword">del</span> kwargs[<span class="string">&quot;key_filename&quot;</span>]</span><br><span class="line"><span class="comment"># Actually connect!</span></span><br><span class="line">self.client.connect(**kwargs)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/python/lib/python3<span class="number">.7</span>/site-packages/paramiko/client.py <span class="keyword">in</span> connect(self, hostname, port, username, password, pkey, key_filename, timeout, allow_agent, look_for_keys, compress, sock, gss_auth, gss_kex, gss_deleg_creds, gss_host, banner_timeout, auth_timeout, gss_trust_dns, passphrase)</span><br><span class="line">    <span class="number">435</span>             gss_deleg_creds,</span><br><span class="line">    <span class="number">436</span>             t.gss_host,</span><br><span class="line">--&gt; <span class="number">437</span>             passphrase,</span><br><span class="line">    <span class="number">438</span>         )</span><br></pre></td></tr></table></figure>

<p>可以看到，在执行connect方法的时候解析参数错误，没有传递passphrase参数，导致ssh连接报错</p>
<p>传参的时候是将kwargs传了过去，刚才我们的参数里面缺少self.connect_kwargs这个参数</p>
<p>connect的定义为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def connect(</span><br><span class="line">        self,</span><br><span class="line">        hostname,</span><br><span class="line">        port=SSH_PORT,</span><br><span class="line">        username=None,</span><br><span class="line">        password=None,      # 你</span><br><span class="line">        pkey=None,          # 你</span><br><span class="line">        key_filename=None,  # 还有你</span><br><span class="line">        timeout=None,</span><br><span class="line">        allow_agent=True,</span><br><span class="line">        look_for_keys=True,</span><br><span class="line">        compress=False,</span><br><span class="line">        sock=None,</span><br><span class="line">        gss_auth=False,</span><br><span class="line">        gss_kex=False,</span><br><span class="line">        gss_deleg_creds=True,</span><br><span class="line">        gss_host=None,</span><br><span class="line">        banner_timeout=None,</span><br><span class="line">        auth_timeout=None,</span><br><span class="line">        gss_trust_dns=True,</span><br><span class="line">        passphrase=None,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>使用password方式:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [27]: c = Connection(&#x27;47.104.148.179&#x27;,user=&#x27;root&#x27;, connect_kwargs=&#123;&#x27;password&#x27;:&#x27;your password&#x27;&#125;)</span><br><span class="line"></span><br><span class="line">In [28]: result = c.run(&#x27;uname -s&#x27;)</span><br><span class="line">Linux</span><br><span class="line"></span><br><span class="line">In [29]: result.stdout.strip() == &quot;Linux&quot;</span><br><span class="line">Out[29]: True</span><br><span class="line"></span><br><span class="line">In [30]: result.exited</span><br><span class="line">Out[30]: 0</span><br><span class="line"></span><br><span class="line">In [31]: result.ok</span><br><span class="line">Out[31]: True</span><br><span class="line"></span><br><span class="line">In [32]: result.command</span><br><span class="line">Out[32]: &#x27;uname -s&#x27;</span><br><span class="line"></span><br><span class="line">In [33]: result.connection</span><br><span class="line">Out[33]: &lt;Connection host=47.104.148.179&gt;</span><br><span class="line"></span><br><span class="line">In [39]: result.connection.host</span><br><span class="line">Out[39]: &#x27;47.104.148.179</span><br></pre></td></tr></table></figure>

<p>使用key_filename方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [11]: c = Connection(&#x27;47.104.148.179&#x27;, user=&#x27;root&#x27;, connect_kwargs=&#123;&#x27;key_filename&#x27;:&#x27;/root/.ssh/authorized_keys&#x27;&#125;</span><br><span class="line">    ...: )</span><br><span class="line"></span><br><span class="line">In [12]: c.run(&quot;uname -s&quot;)</span><br><span class="line">Linux</span><br><span class="line">Out[12]: &lt;Result cmd=&#x27;uname -s&#x27; exited=0&gt;</span><br><span class="line"></span><br><span class="line">In [13]: c.run(&quot;ls&quot;)</span><br><span class="line">coding_time</span><br><span class="line">comment_tree</span><br><span class="line">python_document_manage</span><br><span class="line">python_linux_automation</span><br><span class="line">python_linux_manage</span><br><span class="line">python_linux_monitor</span><br><span class="line">python_linux_network_manage</span><br><span class="line">sys_back</span><br><span class="line">sys_manager</span><br><span class="line">Out[13]: &lt;Result cmd=&#x27;ls&#x27; exited=0&gt;</span><br></pre></td></tr></table></figure>

<p><strong>通过run命令使用sudo提权执行命令</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from fabric import Connection</span><br><span class="line">&gt;&gt;&gt; c = Connection(&#x27;db1&#x27;)</span><br><span class="line">&gt;&gt;&gt; c.run(&#x27;sudo useradd mydbuser&#x27;, pty=True)</span><br><span class="line">[sudo] password:</span><br><span class="line">&lt;Result cmd=&#x27;sudo useradd mydbuser&#x27; exited=0&gt;</span><br><span class="line">&gt;&gt;&gt; c.run(&#x27;id -u mydbuser&#x27;)</span><br><span class="line">1001</span><br><span class="line">&lt;Result cmd=&#x27;id -u mydbuser&#x27; exited=0&gt;</span><br></pre></td></tr></table></figure>



<p><strong>auto-response</strong></p>
<p>自动响应：</p>
<p>当用户是普通用户的时候，可以使用run里面的watchers用法，进行自动响应</p>
<p>添加用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [21]: c.run(&#x27;useradd mydbuser&#x27;, pty=True)</span><br><span class="line">Out[21]: &lt;Result cmd=&#x27;useradd mydbuser&#x27; exited=0&gt;</span><br><span class="line"></span><br><span class="line">In [23]: c.run(&#x27;id mydbuser&#x27;)</span><br><span class="line">uid=1003(mydbuser) gid=1003(mydbuser) groups=1003(mydbuser)</span><br><span class="line">Out[23]: &lt;Result cmd=&#x27;id mydbuser&#x27; exited=0&gt;</span><br></pre></td></tr></table></figure>

<p><strong>执行命令</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">21</span>]: <span class="keyword">from</span> invoke <span class="keyword">import</span> Responder</span><br><span class="line"></span><br><span class="line">In [<span class="number">22</span>]: <span class="keyword">from</span> fabric <span class="keyword">import</span> Connection</span><br><span class="line"></span><br><span class="line">In [<span class="number">23</span>]: c = Connection(<span class="string">&#x27;47.104.148.179&#x27;</span>, user=<span class="string">&#x27;ykyk&#x27;</span>, connect_kwargs=&#123;<span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;123456&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="number">30</span>]: sudopass = Responder( </span><br><span class="line">...:     pattern=<span class="string">r&#x27;\[sudo\] password for ykyk:&#x27;</span>, </span><br><span class="line">...:     response=<span class="string">&#x27;xxxxxxx\n&#x27;</span>, </span><br><span class="line">...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">29</span>]: c.run(<span class="string">&#x27;sudo whoami&#x27;</span>, pty=<span class="literal">True</span>, watchers=[sudopass])</span><br><span class="line"></span><br><span class="line">[sudo] password <span class="keyword">for</span> ykyk: root</span><br><span class="line"></span><br><span class="line">Out[<span class="number">29</span>]: &lt;Result cmd=<span class="string">&#x27;sudo whoami&#x27;</span> exited=<span class="number">0</span>&gt;</span><br></pre></td></tr></table></figure>





<p><strong>高级用法：</strong></p>
<p>watchers/responders 在上一步很有效，但是每次使用使用时都要设置一次模板，在实际环境中不够便利，</p>
<p>Invoke提供 Context.sudo 方法，这个方法能够处理大部分常用情况，而不会越权</p>
<p>使用这个方法之前必须保证用户密码已经存储在环境变量中，剩余的就可以交给Connection.sudo来解决</p>
<p>示例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> getpass</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> fabric <span class="keyword">import</span> Connection, Config</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sudo_pass = getpass.getpass(<span class="string">&quot;What&#x27;s your sudo password?&quot;</span>)</span><br><span class="line">What<span class="string">&#x27;s your sudo password?</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; config = Config(overrides=&#123;&#x27;</span>sudo<span class="string">&#x27;: &#123;&#x27;</span>password<span class="string">&#x27;: sudo_pass&#125;&#125;)</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; c = Connection(&#x27;</span>db1<span class="string">&#x27;, config=config)</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; c.sudo(&#x27;</span>whoami<span class="string">&#x27;, hide=&#x27;</span>stder<span class="string">r&#x27;)</span></span><br><span class="line"><span class="string">root</span></span><br><span class="line"><span class="string">&lt;Result cmd=&quot;...whoami&quot; exited=0&gt;</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; c.sudo(&#x27;</span>useradd mydbuse<span class="string">r&#x27;)</span></span><br><span class="line"><span class="string">&lt;Result cmd=&quot;...useradd mydbuser&quot; exited=0&gt;</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; c.run(&#x27;</span><span class="built_in">id</span> -u mydbuse<span class="string">r&#x27;)</span></span><br><span class="line"><span class="string">1001</span></span><br><span class="line"><span class="string">&lt;Result cmd=&#x27;</span><span class="built_in">id</span> -u mydbuse<span class="string">r&#x27; exited=0&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>传输文件</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: ls</span><br><span class="line">coding_time    python_document_manage/   python_linux_manage/   python_linux_network_manage/  sys_manager/</span><br><span class="line">comment_tree/  python_linux_automation/  python_linux_monitor/  sys_back/</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: <span class="keyword">from</span> fabric <span class="keyword">import</span> Connection</span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: result = Connection(<span class="string">&#x27;own&#x27;</span>).put(<span class="string">&#x27;coding_time&#x27;</span>, remote=<span class="string">&#x27;/tmp/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: <span class="built_in">print</span>(<span class="string">&#x27;Upload &#123;0.local&#125; to &#123;0.remote&#125;&#x27;</span>.<span class="built_in">format</span>(result))</span><br><span class="line">Upload /root/coding_time to /tmp/coding_time</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>多任务整合</strong></p>
<p>示例：</p>
<p>当我们需要上传某个文件到服务器并解压到特定目录时，可以这样写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: ls</span><br><span class="line">binlog2sql-master/                          paramiko-master.<span class="built_in">zip</span>                     vim81/</span><br><span class="line">cclang/                                     Pydiction-master/                       vim-<span class="number">8.1</span>.tar.bz2</span><br><span class="line">c_study/                                    Pydiction-master.<span class="built_in">zip</span>                    vim-master/</span><br><span class="line">master.<span class="built_in">zip</span>                                  pyenv-master.<span class="built_in">zip</span>                        vim-master.<span class="built_in">zip</span></span><br><span class="line">mysql-<span class="number">8.0</span><span class="number">.13</span>-linux-glibc2<span class="number">.12</span>-x86_64.tar.xz  pyenv-virtualenv-master.<span class="built_in">zip</span>             vim-snipmate/</span><br><span class="line">paramiko-master/                            rabbitmq-server-<span class="number">3.6</span><span class="number">.6</span>-<span class="number">1.</span>el7.noarch.rpm</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: <span class="keyword">from</span> fabric <span class="keyword">import</span> Connection</span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: c = Connection(<span class="string">&#x27;own&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: c.put(<span class="string">&#x27;mysql-8.0.13-linux-glibc2.12-x86_64.tar.xz&#x27;</span>,<span class="string">&#x27;/tmp&#x27;</span>)</span><br><span class="line">Out[<span class="number">4</span>]: &lt;fabric.transfer.Result at <span class="number">0x7fedf9e36518</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: c.run(<span class="string">&#x27;tar xf /tmp/mysql-8.0.13-linux-glibc2.12-x86_64.tar.xz -C /tmp&#x27;</span>)</span><br><span class="line">Out[<span class="number">6</span>]: &lt;Result cmd=<span class="string">&#x27;tar xf /tmp/mysql-8.0.13-linux-glibc2.12-x86_64.tar.xz -C /tmp&#x27;</span> exited=<span class="number">0</span>&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们可以直接封装成一个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">7</span>]: <span class="function"><span class="keyword">def</span> <span class="title">upload_file</span>(<span class="params">c</span>):</span></span><br><span class="line">   ...:     c.put(<span class="string">&#x27;mysql-8.0.13-linux-glibc2.12-x86_64.tar.xz&#x27;</span>,<span class="string">&#x27;/tmp&#x27;</span>)</span><br><span class="line">   ...:     c.run(<span class="string">&#x27;tar xf /tmp/mysql-8.0.13-linux-glibc2.12-x86_64.tar.xz -C /tmp&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>在多个服务器上执行命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">3</span>]: <span class="keyword">for</span> host <span class="keyword">in</span> (<span class="string">&#x27;own&#x27;</span>, <span class="string">&#x27;redis&#x27;</span>,<span class="string">&#x27;mysql_test&#x27;</span>):</span><br><span class="line">   ...:     result = Connection(host).run(<span class="string">&#x27;uname -s&#x27;</span>)</span><br><span class="line">   ...:     <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(host, result.stdout.strip()))</span><br><span class="line">   ...:</span><br><span class="line">Linux</span><br><span class="line">own: Linux</span><br><span class="line">Linux</span><br><span class="line">redis: Linux</span><br><span class="line">Linux</span><br><span class="line">mysql_test: Linux</span><br></pre></td></tr></table></figure>

<p>还可以使用fabric中的SerialGroup方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [4]: from fabric import SerialGroup as Group</span><br><span class="line"></span><br><span class="line">In [5]: results = Group(&#x27;own&#x27;, &#x27;redis&#x27;, &#x27;mysql_test&#x27;).run(&#x27;uname -s&#x27;)</span><br><span class="line">Linux</span><br><span class="line">Linux</span><br><span class="line">Linux</span><br><span class="line"></span><br><span class="line">In [8]: for connection, result in results.items():</span><br><span class="line">   ...:     print(&quot;&#123;0.host&#125;: &#123;1.stdout&#125;&quot;.format(connection, result))</span><br><span class="line">   ...:</span><br><span class="line">   ...:</span><br><span class="line">47.104.148.xx: Linux</span><br><span class="line"></span><br><span class="line">116.62.195.xx: Linux</span><br><span class="line"></span><br><span class="line">47.99.123.xx: Linux</span><br></pre></td></tr></table></figure>

<p>集成到一起：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fabric <span class="keyword">import</span> SerialGroup <span class="keyword">as</span> Group</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_and_unpack</span>(<span class="params">c</span>):</span></span><br><span class="line">    <span class="keyword">if</span> c.run(<span class="string">&#x27;test -f /opt/mydata/myfile&#x27;</span>, warn=<span class="literal">True</span>).failed:</span><br><span class="line">        c.put(<span class="string">&#x27;myfiles.tgz&#x27;</span>, <span class="string">&#x27;/opt/mydata&#x27;</span>)</span><br><span class="line">        c.run(<span class="string">&#x27;tar -C /opt/mydata -xzvf /opt/mydata/myfiles.tgz&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> connection <span class="keyword">in</span> Group(<span class="string">&#x27;web1&#x27;</span>, <span class="string">&#x27;web2&#x27;</span>, <span class="string">&#x27;web3&#x27;</span>):</span><br><span class="line">    upload_and_unpack(connection)</span><br></pre></td></tr></table></figure>





<p><strong>fabric 命令行工具</strong></p>
<p>fabric提供了一个类似Shell终端的工具：fab</p>
<p>fab执行命令时，默认引用一个名称为fabfile.py的文件，这个文件包含一个到多个函数，使用fab命令可以调用这些函数， 函数在fabric中成为task</p>
<p>下面给出fabfile.py的样例文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from fabric import task</span><br><span class="line"></span><br><span class="line">@task</span><br><span class="line">def hostname(c):</span><br><span class="line">    c.run(&#x27;hostname&#x27;)</span><br><span class="line"></span><br><span class="line">@task</span><br><span class="line">def ls(path=&#x27;.&#x27;):</span><br><span class="line">    c.run(&#x27;ls &#123;&#125;&#x27;.format(path))</span><br><span class="line"></span><br><span class="line">def tail(path=&#x27;/etc/passwd&#x27;, line=10):</span><br><span class="line">    sudo(&#x27;tail -n &#123;0&#125;, &#123;1&#125;&#x27;.format(line, path))</span><br></pre></td></tr></table></figure>



<blockquote>
<p>注意： 新版本的fab取消了api，所以相应的方法较之旧版本使用起来更加简洁，许多方法较之以前变化较大</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ykyk python_linux_automation]# fab3 --list</span><br><span class="line">Available tasks:</span><br><span class="line"></span><br><span class="line">  hostname</span><br><span class="line">  ls</span><br></pre></td></tr></table></figure>

<p>获取服务器信息需要在命令行指定：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ykyk python_linux_automation]# fab3 -H mysql_test hostname</span><br><span class="line">izbp1cmbkj49ynx81cezu3z</span><br><span class="line"></span><br><span class="line">[root@ykyk python_linux_automation]# fab3 -H mysql_test,own,redis  hostname</span><br><span class="line">izbp1cmbkj49ynx81cezu3z</span><br><span class="line">ykyk</span><br><span class="line">izbp1a43b9q4zlsifma7muz</span><br></pre></td></tr></table></figure>



<p><strong>fab命令行参数：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@ykyk python_linux_automation]<span class="comment"># fab3 --help </span></span><br><span class="line">Usage: fab3 [--core-opts] task1 [--task1-opts] ... taskN [--taskN-opts]</span><br><span class="line"></span><br><span class="line">Core options:</span><br><span class="line"></span><br><span class="line">  --complete                         Print tab-completion candidates <span class="keyword">for</span> given parse remainder.</span><br><span class="line">  --hide=STRING                      <span class="type">Set</span> default value of run()<span class="string">&#x27;s &#x27;</span>hide<span class="string">&#x27; kwarg.</span></span><br><span class="line"><span class="string">  --no-dedupe                        Disable task deduplication.</span></span><br><span class="line"><span class="string">  --print-completion-script=STRING   Print the tab-completion script for your preferred shell (bash|zsh|fish).</span></span><br><span class="line"><span class="string">  --prompt-for-login-password        Request an upfront SSH-auth password prompt.</span></span><br><span class="line"><span class="string">  --prompt-for-passphrase            Request an upfront SSH key passphrase prompt.</span></span><br><span class="line"><span class="string">  --prompt-for-sudo-password         Prompt user at start of session for the sudo.password config value.</span></span><br><span class="line"><span class="string">  --write-pyc                        Enable creation of .pyc files.</span></span><br><span class="line"><span class="string">  -c STRING, --collection=STRING     Specify collection name to load.</span></span><br><span class="line"><span class="string">  -d, --debug                        Enable debug output.</span></span><br><span class="line"><span class="string">  -D INT, --list-depth=INT           When listing tasks, only show the first INT levels.</span></span><br><span class="line"><span class="string">  -e, --echo                         Echo executed commands before running.</span></span><br><span class="line"><span class="string">  -f STRING, --config=STRING         Runtime configuration file to use.</span></span><br><span class="line"><span class="string">  -F STRING, --list-format=STRING    Change the display format used when listing tasks. Should be one of: flat</span></span><br><span class="line"><span class="string">                                     (default), nested, json.</span></span><br><span class="line"><span class="string">  -h [STRING], --help[=STRING]       Show core or per-task help and exit.</span></span><br><span class="line"><span class="string">  -H STRING, --hosts=STRING          Comma-separated host name(s) to execute tasks against.</span></span><br><span class="line"><span class="string">  -i, --identity                     Path to runtime SSH identity (key) file. May be given multiple times.</span></span><br><span class="line"><span class="string">  -l [STRING], --list[=STRING]       List available tasks, optionally limited to a namespace.</span></span><br><span class="line"><span class="string">  -p, --pty                          Use a pty when executing shell commands.</span></span><br><span class="line"><span class="string">  -r STRING, --search-root=STRING    Change root directory used for finding task modules.</span></span><br><span class="line"><span class="string">  -S STRING, --ssh-config=STRING     Path to runtime SSH config file.</span></span><br><span class="line"><span class="string">  -V, --version                      Show version and exit.</span></span><br><span class="line"><span class="string">  -w, --warn-only                    Warn, instead of failing, when shell commands fail.</span></span><br></pre></td></tr></table></figure>

<ul>
<li>pty</li>
</ul>
<p>pty用于设置伪终端，如果执行命令后需要一个常驻的服务进程，需要设置为pty=False,避免因fabric退出而导致程序退出</p>
<p><strong>fabric装饰器</strong></p>
<ol>
<li><p>fabric中的task</p>
</li>
<li><ul>
<li><p>task是fabric需要在远程服务器执行的任务，</p>
</li>
<li><ul>
<li>默认情况下，fabfile中的所有可调用对象都是task，python中的函数是一个可调用对象</li>
<li>继承fabric的task类，不推荐</li>
<li>使用fabric装饰器，注意：如果fabfile中定义了多个task，只有其中一个使用了task，那么其他notask函数不是task</li>
</ul>
</li>
</ul>
</li>
<li><p>role新版本取消了。使用SerialGroup</p>
</li>
<li><p>runs_once 只运行一次</p>
</li>
</ol>
<p>以上就是fabric的一些方法</p>
<p>-————————————————————————————————————</p>
<p>案例：使用fabric源码安装redis</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fabric <span class="keyword">import</span> task</span><br><span class="line"><span class="keyword">from</span> fabric <span class="keyword">import</span> connection</span><br><span class="line"><span class="keyword">from</span> invoke <span class="keyword">import</span> Exit</span><br><span class="line"><span class="keyword">from</span> invocations.console <span class="keyword">import</span> confirm</span><br><span class="line"></span><br><span class="line">hosts = [<span class="string">&#x27;own&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@task</span><span class="comment">#(hosts=&#x27;own&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">c</span>):</span></span><br><span class="line">    <span class="keyword">with</span> c.prefix(<span class="string">&#x27;cd /root/python_linux_automation/redis-4.0.9&#x27;</span>):</span><br><span class="line">        result = c.run(<span class="string">&#x27;make &amp;&amp;  make test&#x27;</span>, warn=<span class="literal">True</span>, pty=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> result.failed <span class="keyword">and</span> <span class="keyword">not</span> confirm(<span class="string">&#x27;Tests failed, continue anyway?&#x27;</span>):</span><br><span class="line">            <span class="keyword">raise</span> SystemExit(<span class="string">&quot;Aborting at user requeset&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;All tests passed without errors&#x27;</span>)</span><br><span class="line">            c.run(<span class="string">&#x27;make clean&#x27;</span>, warn=<span class="literal">True</span>, pty=<span class="literal">False</span>, hide=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> c.prefix(<span class="string">&quot;cd /root/python_linux_automation/&quot;</span>):</span><br><span class="line">        c.run(<span class="string">&#x27;tar -czf redis-4.0.9.tar.gz redis-4.0.9&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deploy</span>(<span class="params">c</span>):</span></span><br><span class="line">    c.put(<span class="string">&#x27;redis-4.0.9.tar.gz&#x27;</span>, <span class="string">&#x27;/tmp/redis-4.0.9.tar.gz&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> c.cd(<span class="string">&#x27;/tmp&#x27;</span>):</span><br><span class="line">        c.run(<span class="string">&#x27;tar xzf redis-4.0.9.tar.gz&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> c.cd(<span class="string">&#x27;redis-4.0.9&#x27;</span>):</span><br><span class="line">            c.run(<span class="string">&#x27;make&#x27;</span>)</span><br><span class="line">            <span class="keyword">with</span> c.cd(<span class="string">&#x27;src&#x27;</span>):</span><br><span class="line">                c.run(<span class="string">&#x27;make install&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean_file</span>(<span class="params">c</span>):</span></span><br><span class="line">    <span class="keyword">with</span> c.cd(<span class="string">&#x27;/tmp&#x27;</span>):</span><br><span class="line">        c.run(<span class="string">&#x27;rm -rf redis-4.0.9.tar.gz&#x27;</span>)</span><br><span class="line">        c.run(<span class="string">&#x27;rm -rf redis-4.0.9&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean_local_file</span>(<span class="params">c</span>):</span></span><br><span class="line">    <span class="keyword">with</span> c.prefix(<span class="string">&#x27;cd /root/python_linux_automation/&#x27;</span>):</span><br><span class="line">        c.run(<span class="string">&#x27;rm -rf redis-4.0.9.tar.gz&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">install</span>(<span class="params">c</span>):</span></span><br><span class="line">    <span class="keyword">for</span> host <span class="keyword">in</span> hosts:</span><br><span class="line">        c = connection.Connection(<span class="string">&#x27;own&#x27;</span>)</span><br><span class="line">        test(c)</span><br><span class="line">        deploy(c)</span><br><span class="line">        clean_file(c)</span><br><span class="line">        clean_local_file(c)</span><br></pre></td></tr></table></figure>

    </div>
    <!--文末结束语-->
    
        <div style="text-align:center;color: #ccc;font-size:24px;"> --- 本文结束 <i class="fas fa-heart"></i> The End --- </div>
    
    <!--页脚广告-->
    
    <v-divider></v-divider>
    
    <div class="post-nav">             
        
            <div class="post-nav-button float-left">
                <v-icon>chevron_left</v-icon>
                <a class="font-weight-bold text-left" href="/2019/03/23/MySQL%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E6%96%B9%E6%A1%88/">
                    MySQL数据备份方案
                </a>
            </div>
              
          
            <div class="post-nav-button float-right">
                <a class="font-weight-bold text-right" href="/2019/03/19/Zabbix%E7%9B%91%E6%8E%A7%E6%96%87%E6%A1%A3-%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6/">      
                    Zabbix监控文档-配置邮件告警
                </a>
                <v-icon>chevron_right</v-icon>
            </div>
        
    </div>
</v-card>



        
                            <div id="mobile-footer" class="d-block d-md-none">
                                <v-divider></v-divider>
                                <div id="mobile-footer-content">
                                    <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a> &nbsp; Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
                                    <span> &copy; 2015 - 2021 yhkl</span>
                                </div>
                            </div>                   
                        </v-col>                                            
                    </v-row>
                </v-container>
            </v-content>
        </v-app>
    </div>
    
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script>

<script src="/js/main.js"></script>




    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>





</body>
</html>