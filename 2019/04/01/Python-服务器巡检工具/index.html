<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="shortcut icon" href="/images/favicon.png">
    
     
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet">
    
<link rel="stylesheet" href="/css/main.css">

    
    







    
    
          

    
    
    
    
    <title>
        
            Python--服务器巡检工具 | YHKL Blog
        
    </title>
    
    
<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    <div id="app">
        <v-app>
            <v-content id="page">
                <v-container fluid>
                    <v-row>
                        <v-col cols="2" class="d-none d-md-block">
                            <div id="sidebar" class="float-right">
    <a href="/" rel="home">
        <v-avatar size=96>
            <img id="logo" src="/images/avatar.png">     
        </v-avatar> 
    </a>
    <v-divider></v-divider>
    <div class="mini-menu">
        <v-btn icon href="/">
            <v-icon>home</v-icon>
        </v-btn>
        <v-btn icon href="/categories/">
            <v-icon>folder</v-icon>
        </v-btn>
        <v-btn icon href="/tags/">
            <v-icon>bookmark</v-icon>
        </v-btn>
        <v-btn icon @click="SetNightMode">
            <v-icon>{{ nightMode }}</v-icon>
        </v-btn>
    </div>
    <v-list id="main-menu" class="font-weight-bold" flat>
        
            
            <v-list-item href="/" link>
            <v-list-item-icon><v-icon>home</v-icon></v-list-item-icon>
            <v-list-item-content>
                Home
            </v-list-item-content>
            </v-list-item>
        
            
            <v-list-item href="/archives/" link>
            <v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon>
            <v-list-item-content>
                Archives
            </v-list-item-content>
            </v-list-item>
        
            
            <v-list-item href="/about/" link>
            <v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon>
            <v-list-item-content>
                About
            </v-list-item-content>
            </v-list-item>
        
    </v-list>
    <v-divider></v-divider>
    
        <div class="post-toc">
            <a href="/2019/04/01/Python-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B7%A1%E6%A3%80%E5%B7%A5%E5%85%B7/" class="toc-header">Table of Contents</a>
            <div class="toc-content">
                
            </div>
        </div>
    

    <div id="footer">
        <div class="footer-social">
            
                
                <v-btn icon href="mailto:kb1000fx@gmail.com" target="_blank">
                    <v-icon>fas fa-envelope</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://github.com/yhkl-dev" target="_blank">
                    <v-icon>fab fa-github</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://steamcommunity.com/profiles/76561198346798163" target="_blank">
                    <v-icon>fab fa-steam</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://weibo.com/kb1000fx" target="_blank">
                    <v-icon>fab fa-weibo</v-icon>
                </v-btn>
            
        </div>
        <v-divider></v-divider>
        <div class="footer-content">
            
                <span id="busuanzi_container_site_uv" style="display: none;"> 
                    Total Visitors <span id="busuanzi_value_site_uv"></span>
                </span>
                <br>
            
            <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a></span><br>
            <span>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
            <span>
                &copy; 2015 - 2021 
                yhkl
            </span>
        </div>
    </div>
</div>

                        </v-col>
                        <v-col cols="12" md="10">
                            <v-row>
  <v-col cols="12" md="8" align-self="end">
    <div id="site-header">
      <div id="site-title">
        <a href="/" rel="home">YHKL Blog</a>
      </div>
      <div id="site-description"></div>
      <div id="mobile-menu" class="d-block d-md-none">
        <v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,false)"></v-text-field>
        <div class="mobile-mini-menu">
          <v-btn icon href="/">
              <v-icon>home</v-icon>
          </v-btn>
          <v-btn icon href="/categories/">
              <v-icon>folder</v-icon>
          </v-btn>
          <v-btn icon href="/tags/">
              <v-icon>bookmark</v-icon>
          </v-btn>
          <v-btn icon @click="SetNightMode">
              <v-icon>{{ nightMode }}</v-icon>
          </v-btn>
          
            
            <v-btn icon href="/">
              <v-icon>home</v-icon>
            </v-btn>
          
            
            <v-btn icon href="/archives/">
              <v-icon>archive</v-icon>
            </v-btn>
          
            
            <v-btn icon href="/about/">
              <v-icon>account_circle</v-icon>
            </v-btn>
          
        </div>
      </div>    
    </div>
  </v-col>  
  <v-col cols="4" align-self="end" class="d-none d-md-block">
    <v-col align-self="end">
      <v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,false)"></v-text-field>
    </v-col> 
  </v-col>
</v-row>

                            <v-card class="elevation-2 post-card">
    
    
        <div class="post-header">
  <a class="post-header-title font-weight-medium" href="/2019/04/01/Python-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B7%A1%E6%A3%80%E5%B7%A5%E5%85%B7/">Python--服务器巡检工具</a>
  <div class="post-header-meta">   
    <span>
      <v-icon color="">event</v-icon>
      Posted on:&nbsp;2019-04-01
    </span>
    <span>
      <v-icon color="">event_available</v-icon>
      Edited on:&nbsp;2021-10-30
    </span>
    <span>
      <v-icon color="">folder</v-icon>
      In:&nbsp;Uncategorized
    </span>
    
    <span>
      <v-icon color="">visibility</v-icon>
      Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
    </span>
    
  </div>
</div>

    
    
    
    
    <div class="post-content typo">
        <blockquote>
<p>最近因为要做服务器巡检，就自己写了个服务器的巡检工具，各个服务器信息通过<code>redis</code>发送到服务器进行处理，处理成<code>pdf</code>文件生成报告</p>
</blockquote>
<p>客户端</p>
<p><code>gather_server_info_client</code><br>├── <code>hostinfo.py</code><br>├── <code>send_message.py</code><br>└── <code>util.py</code></p>
<p>代码如下：</p>
<ul>
<li><p><code>send_message.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/python/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">############################</span></span><br><span class="line"><span class="comment">#File Name: send_message.py</span></span><br><span class="line"><span class="comment">#Author: ykyk</span></span><br><span class="line"><span class="comment">#Mail: 525178992@qq.com</span></span><br><span class="line"><span class="comment">#Created Time: 2019-03-26 13:01:07</span></span><br><span class="line"><span class="comment">############################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> hostinfo <span class="keyword">import</span> HostManager</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">conn = redis.Redis(host=<span class="string">&#x27;192.168.1.40&#x27;</span>,port=<span class="number">6379</span>, db=<span class="number">10</span>)</span><br><span class="line">data = HostManager()()</span><br><span class="line"></span><br><span class="line">hostname = data[<span class="string">&#x27;hostname&#x27;</span>]</span><br><span class="line">send_time = datetime.now().strftime(<span class="string">&#x27;%Y%m%d%H%M&#x27;</span>) </span><br><span class="line"><span class="comment"># print(data)</span></span><br><span class="line">mesg = &#123;</span><br><span class="line">    <span class="string">&#x27;hostname&#x27;</span>: hostname,</span><br><span class="line">    <span class="string">&#x27;send_time&#x27;</span>: <span class="built_in">str</span>(send_time),</span><br><span class="line">    <span class="string">&#x27;server_info&#x27;</span>: data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(mesg[&#x27;server_info&#x27;][&#x27;ip_address&#x27;])</span></span><br><span class="line">conn.publish(<span class="string">&quot;checking_server&quot;</span>, json.dumps(mesg).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>util.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/python/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">############################</span></span><br><span class="line"><span class="comment">#File Name: hostinfo.py</span></span><br><span class="line"><span class="comment">#Author: ykyk</span></span><br><span class="line"><span class="comment">#Mail: 525178992@qq.com</span></span><br><span class="line"><span class="comment">#Created Time: 2019-03-26 12:57:27</span></span><br><span class="line"><span class="comment">############################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> util <span class="keyword">import</span> bytes2human</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HostManager</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.data = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cpu_info</span>(<span class="params">self</span>):</span></span><br><span class="line">        cpu_count = psutil.cpu_count()</span><br><span class="line">        cpu_percent = psutil.cpu_percent(interval=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(cpu_count=cpu_count, cpu_percent=cpu_percent)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_disk_info</span>(<span class="params">self</span>):</span></span><br><span class="line">        disk_usage = psutil.disk_usage(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        disk_total = bytes2human(disk_usage.total)</span><br><span class="line">        disk_percent = disk_usage.percent</span><br><span class="line">        disk_free = bytes2human(disk_usage.free)</span><br><span class="line">        disk_used = bytes2human(disk_usage.used)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  <span class="built_in">dict</span>(disk_total=disk_total,</span><br><span class="line">                     disk_percent=disk_percent,</span><br><span class="line">                     disk_free=disk_free,</span><br><span class="line">                     disk_uesd=disk_used)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_boot_info</span>(<span class="params">self</span>):</span></span><br><span class="line">        boot_time = datetime.fromtimestamp(psutil.boot_time()).strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(boot_time=boot_time)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_host_name</span>(<span class="params">self</span>):</span></span><br><span class="line">        hostname = socket.gethostname()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(hostname=hostname)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_ip_address</span>(<span class="params">self</span>):</span></span><br><span class="line">        info = psutil.net_if_addrs()</span><br><span class="line">        <span class="keyword">for</span> key,val <span class="keyword">in</span> info.items():</span><br><span class="line">            <span class="keyword">if</span> key==<span class="string">&#x27;ens33&#x27;</span> <span class="keyword">or</span> key==<span class="string">&#x27;eth0&#x27;</span> <span class="keyword">or</span> key==<span class="string">&#x27;br0&#x27;</span> <span class="keyword">or</span> key==<span class="string">&#x27;eno1&#x27;</span>:</span><br><span class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> val:</span><br><span class="line">                    <span class="keyword">if</span> item[<span class="number">0</span>] == <span class="number">2</span> <span class="keyword">and</span> <span class="keyword">not</span> item[<span class="number">1</span>] == <span class="string">&#x27;127.0.0.1&#x27;</span> :</span><br><span class="line">                        <span class="keyword">return</span>  <span class="built_in">dict</span>(ip_address=item[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_memory_info</span>(<span class="params">self</span>):</span></span><br><span class="line">        virtual_mem = psutil.virtual_memory()</span><br><span class="line">        mem_total = bytes2human(virtual_mem.total)</span><br><span class="line">        mem_percent = virtual_mem.percent</span><br><span class="line">        mem_free = bytes2human(virtual_mem.free + virtual_mem.cached + virtual_mem.buffers)</span><br><span class="line">        mem_used = bytes2human(virtual_mem.total * virtual_mem.percent / <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(mem_total=mem_total, </span><br><span class="line">                    mem_percent=mem_percent,</span><br><span class="line">                    mem_free=mem_free, </span><br><span class="line">                    mem_used=mem_used)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_io_stats</span>(<span class="params">self</span>):</span></span><br><span class="line">        t1 = psutil.disk_io_counters()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        t2 = psutil.disk_io_counters()</span><br><span class="line">        read_bytes = bytes2human(t2.read_bytes - t1.read_bytes)</span><br><span class="line">        write_bytes = bytes2human(t2.write_bytes - t1.write_bytes)</span><br><span class="line">        tps = t2.read_count + t2.write_count - t1.read_count - t1.write_count</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(tps=tps,</span><br><span class="line">                   read_bytes=read_bytes,</span><br><span class="line">                   write_bytes=write_bytes)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_key</span>(<span class="params">self</span>):</span></span><br><span class="line">        key_info = psutil.net_io_counters(pernic=<span class="literal">True</span>).keys()</span><br><span class="line">        recv = &#123;&#125;</span><br><span class="line">        sent = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> key_info:</span><br><span class="line">            recv.setdefault(key,</span><br><span class="line">                            psutil.net_io_counters(pernic=<span class="literal">True</span>).get(key).bytes_recv)</span><br><span class="line">            sent.setdefault(key,</span><br><span class="line">                            psutil.net_io_counters(pernic=<span class="literal">True</span>).get(key).bytes_sent)</span><br><span class="line">        <span class="keyword">return</span> key_info, recv, sent</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_rate</span>(<span class="params">self, func</span>):</span></span><br><span class="line">        key_info, old_recv, old_sent = func()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        key_info, now_recv, now_sent = func()</span><br><span class="line">        net_in = &#123;&#125;</span><br><span class="line">        net_out = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> key_info:</span><br><span class="line">            net_in.setdefault(key, (now_recv.get(key) - old_recv.get(key)) / <span class="number">1024</span>)</span><br><span class="line">            net_out.setdefault(key, (now_sent.get(key) - old_sent.get(key)) / <span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">dict</span>(key_info=key_info,</span><br><span class="line">                net_in=net_in,</span><br><span class="line">                net_out=net_out)</span><br><span class="line">        <span class="keyword">return</span> key_info, net_in, net_out</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_net_stats</span>(<span class="params">self</span>):</span></span><br><span class="line">        key_info, net_in, net_out = self.get_rate(self.get_key)</span><br><span class="line">        stats_data = []</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> key_info:</span><br><span class="line">            a = <span class="built_in">dict</span>(key=key, net_in=net_in.get(key), net_out=net_out.get(key))</span><br><span class="line">            stats_data.append(a)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(net_info=stats_data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.data.update(self.get_host_name())</span><br><span class="line">        self.data.update(self.get_boot_info())</span><br><span class="line">        self.data.update(self.get_cpu_info())</span><br><span class="line">        self.data.update(self.get_memory_info())</span><br><span class="line">        self.data.update(self.get_disk_info())</span><br><span class="line">        self.data.update(self.get_io_stats())</span><br><span class="line">        self.data.update(self.get_net_stats())</span><br><span class="line">        self.data.update(self.get_ip_address())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.data</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    data = HostManager()()</span><br><span class="line">    <span class="built_in">print</span>(data)</span><br></pre></td></tr></table></figure></li>
<li><p><code>hostinfo.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/python/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">############################</span></span><br><span class="line"><span class="comment">#File Name: util.py</span></span><br><span class="line"><span class="comment">#Author: ykyk</span></span><br><span class="line"><span class="comment">#Mail: 525178992@qq.com</span></span><br><span class="line"><span class="comment">#Created Time: 2019-03-26 12:58:16</span></span><br><span class="line"><span class="comment">############################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_disk_capacity</span>(<span class="params">path</span>):</span></span><br><span class="line">    <span class="keyword">return</span> psutil.disk_usage(path).total</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bytes2human</span>(<span class="params">n</span>):</span></span><br><span class="line">    symbols = (<span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">    prefix = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i, s <span class="keyword">in</span> <span class="built_in">enumerate</span>(symbols):</span><br><span class="line">        prefix[s] = <span class="number">1</span> &lt;&lt; (i + <span class="number">1</span>) * <span class="number">10</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">reversed</span>(symbols):</span><br><span class="line">        <span class="keyword">if</span> n &gt;= prefix[s]:</span><br><span class="line">            value = <span class="built_in">float</span>(n) / prefix[s]</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;%.1f%s&quot;</span> % (value, s)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&#123;&#125;B&quot;</span>.<span class="built_in">format</span>(n)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>服务端</p>
<p><code>server_handle/</code><br>├──<code> check_report</code><br>├── <code>execute_system_check.py</code><br>├── <code> html_files</code><br>├── <code>pdf_files</code><br>├── <code>server_handle.py</code><br>└── <code>template</code><br>    └──<code> template.html</code></p>
<ul>
<li><p><code>template/template.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css&quot;</span> <span class="attr">integrity</span>=<span class="string">&quot;sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm&quot;</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h6</span>&gt;</span>主机名称：&#123;&#123;hostname&#125;&#125;<span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h6</span>&gt;</span>IP地址：&#123;&#123;server_info.ip_address&#125;&#125;<span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h6</span>&gt;</span>巡检时间：&#123;&#123;send_time&#125;&#125;<span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-striped&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>名称<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>当前值<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>参考值<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- &#123;&#123; server_info &#125;&#125; --&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- &lt;th scope=&quot;row&quot;&gt;&lt;/th&gt; --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>主机名称<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.hostname&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>开机时间<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.boot_time&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>CPU总数<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.cpu_count&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>CPU利用率<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.cpu_percent&#125;&#125;%<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="symbol">&amp;lt;</span>90%<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>内存大小<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.mem_total&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>内存利用率<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.mem_percent&#125;&#125;%<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="symbol">&amp;lt;</span>90%<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>空闲内存<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.mem_free&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>已用内存<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.mem_used&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>磁盘容量<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.disk_total&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>磁盘利用率<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.disk_percent&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="symbol">&amp;lt;</span>80%<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>磁盘已用空间<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.disk_uesd&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>IOPS<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.tps&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>每秒读取次数<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.read_bytes&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>每秒写入速度<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;server_info.write_bytes&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    &#123;% for net in server_info.net_info%&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>网卡设备名称<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;net.key&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>每秒接受流量<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;net.net_in&#125;&#125;k<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>每秒发送流量<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;net.net_out&#125;&#125;k<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>None<span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    &#123;% endfor %&#125;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js&quot;</span> <span class="attr">integrity</span>=<span class="string">&quot;sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN&quot;</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js&quot;</span> <span class="attr">integrity</span>=<span class="string">&quot;sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q&quot;</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js&quot;</span> <span class="attr">integrity</span>=<span class="string">&quot;sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl&quot;</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>server_handle.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/python/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">############################</span></span><br><span class="line"><span class="comment">#File Name: server.py</span></span><br><span class="line"><span class="comment">#Author: ykyk</span></span><br><span class="line"><span class="comment">#Mail: 525178992@qq.com</span></span><br><span class="line"><span class="comment">#Created Time: 2019-03-26 13:13:35</span></span><br><span class="line"><span class="comment">############################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> jinja2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pdfkit</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> PyPDF2 <span class="keyword">import</span> PdfFileMerger</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">HTML_FILE_PATH = <span class="string">&#x27;/home/ykyk/gather_server_info/server_handle/html_files/&#x27;</span></span><br><span class="line">PDF_FILE_PATH = <span class="string">&#x27;/home/ykyk/gather_server_info/server_handle/pdf_files/&#x27;</span></span><br><span class="line">MERGE_PDF_FILE_PATH = <span class="string">&#x27;/home/ykyk/gather_server_info/server_handle/check_report/&#x27;</span></span><br><span class="line"></span><br><span class="line">cur_date = datetime.now().strftime(<span class="string">&#x27;%Y%m%d&#x27;</span>)</span><br><span class="line">pool = redis.ConnectionPool(host=<span class="string">&#x27;192.168.1.40&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">10</span>)</span><br><span class="line">conn = redis.StrictRedis(connection_pool=pool)</span><br><span class="line">p = conn.pubsub()</span><br><span class="line">p.subscribe(<span class="string">&#x27;checking_server&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transform_ip</span>(<span class="params">ip</span>):</span></span><br><span class="line">    a = ip.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    new_ip = <span class="string">&#x27;-&#x27;</span>.join(a)</span><br><span class="line">    <span class="keyword">return</span> new_ip</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render</span>(<span class="params">tpl_path, **kwargs</span>):</span></span><br><span class="line">    path, filename = os.path.split(tpl_path)</span><br><span class="line">    <span class="keyword">return</span> jinja2.Environment( </span><br><span class="line">        loader = jinja2.FileSystemLoader(path <span class="keyword">or</span> <span class="string">&#x27;./&#x27;</span>)</span><br><span class="line">    ).get_template(filename).render(**kwargs)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge_pdf</span>(<span class="params">pdf_file_path, pdfs, merge_pdf_file_path</span>):</span></span><br><span class="line">    merger = PdfFileMerger()</span><br><span class="line">    <span class="keyword">for</span> pdf <span class="keyword">in</span> pdfs:</span><br><span class="line">        <span class="built_in">print</span>(pdf)</span><br><span class="line">        merger.append(<span class="built_in">open</span>(pdf_file_path+pdf, <span class="string">&#x27;rb&#x27;</span>))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;&#123;&#125;&#123;&#125;.pdf&#x27;</span>.<span class="built_in">format</span>(merge_pdf_file_path,<span class="string">&#x27;server_report_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(cur_date)), <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">        merger.write(fout)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;MERGE PDF FILE OK!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_html</span>(<span class="params">server_info, file_path</span>):</span></span><br><span class="line">    content = render(<span class="string">&#x27;./template/template.html&#x27;</span>, **server_info)</span><br><span class="line">    file_name = <span class="string">&#x27;&#123;&#125;.html&#x27;</span>.<span class="built_in">format</span>(transform_ip(server_info[<span class="string">&#x27;server_info&#x27;</span>][<span class="string">&#x27;ip_address&#x27;</span>]))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path+file_name, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(content)</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> file_path, file_name</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_pdf</span>(<span class="params">html_file_path, html_file_name, pdf_file_path</span>):</span></span><br><span class="line">    file_name = html_file_name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(file_name)</span><br><span class="line">    pdf_file_name = <span class="string">&#x27;&#123;&#125;.pdf&#x27;</span>.<span class="built_in">format</span>(file_name)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pdfkit.from_file(html_file_path+html_file_name, pdf_file_path+pdf_file_name)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;GENERATE PDF SUCCESS&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> pdf_file_name</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv_mesg</span>(<span class="params">html_file_path, pdf_file_path, merge_pdf_file_path</span>):</span></span><br><span class="line">    ip_address_list = []</span><br><span class="line">    server_list = []</span><br><span class="line">    html_files = []</span><br><span class="line">    pdf_files = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> p.listen():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Listen on channel: %s&quot;</span> %item[<span class="string">&#x27;channel&#x27;</span>].decode())</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;message&#x27;</span>:</span><br><span class="line">            data = item[<span class="string">&#x27;data&#x27;</span>].decode()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;From [&#123;&#125;] get message: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(item[<span class="string">&#x27;channel&#x27;</span>].decode(),</span><br><span class="line">                                                   item[<span class="string">&#x27;data&#x27;</span>].decode()))</span><br><span class="line">            host_info = json.loads(data)</span><br><span class="line">            ip = host_info[<span class="string">&#x27;server_info&#x27;</span>][<span class="string">&#x27;ip_address&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> ip_address_list:</span><br><span class="line">                ip_address_list.append(ip)</span><br><span class="line">                server_list.append(host_info)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;length fo server_list:&quot;</span>, <span class="built_in">len</span>(server_list))</span><br><span class="line">            <span class="string">&#x27;&#x27;&#x27; to html &#x27;&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">for</span> server_info <span class="keyword">in</span> server_list:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Generating html files...&#x27;</span>)</span><br><span class="line">                html_file_path, html_file_name = generate_html(server_info, html_file_path)</span><br><span class="line">                <span class="keyword">if</span> html_file_name <span class="keyword">not</span> <span class="keyword">in</span> html_files:</span><br><span class="line">                    html_files.append(html_file_name)</span><br><span class="line">                    time.sleep(<span class="number">5</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;Generating pdf files...&#x27;</span>)</span><br><span class="line">                    <span class="string">&#x27;&#x27;&#x27; to pdf &#x27;&#x27;&#x27;</span></span><br><span class="line">                    pdf_file = generate_pdf(html_file_path, html_file_name, pdf_file_path)</span><br><span class="line">                    <span class="keyword">if</span> pdf_file <span class="keyword">not</span> <span class="keyword">in</span> pdf_files:</span><br><span class="line">                        pdf_files.append(pdf_file)</span><br><span class="line">                        time.sleep(<span class="number">5</span>)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;Merge pdf files...&#x27;</span>)</span><br><span class="line">                        <span class="string">&#x27;&#x27;&#x27; merge pdf &#x27;&#x27;&#x27;</span></span><br><span class="line">                        merge_pdf(pdf_file_path, pdf_files, merge_pdf_file_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    recv_mesg(HTML_FILE_PATH, PDF_FILE_PATH, MERGE_PDF_FILE_PATH)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>execute_system_check.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"></span><br><span class="line">host_list = [</span><br><span class="line">	&#123;LIST&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_system_check</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(host_list))</span><br><span class="line">    <span class="keyword">for</span> host <span class="keyword">in</span> host_list:</span><br><span class="line">        ssh = paramiko.SSHClient()</span><br><span class="line">        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">        ssh.connect(hostname=host[<span class="string">&#x27;hostname&#x27;</span>], port=<span class="number">22</span>, username=host[<span class="string">&#x27;username&#x27;</span>], password=host[<span class="string">&#x27;password&#x27;</span>])</span><br><span class="line">        stdin, stdout, stderr = ssh.exec_command(<span class="string">&#x27;python /root/gather_server_info/send_message.py&#x27;</span>)</span><br><span class="line">        result = stdout.read() <span class="keyword">if</span> stdout.read() <span class="keyword">else</span> stderr.read()</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;Execute command on host [&#123;&#125;] \n result: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(host[<span class="string">&#x27;hostname&#x27;</span>],result.decode()))</span><br><span class="line">        ssh.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">senf_file_to_remote_server</span>(<span class="params">local_file_name, remote_file_name</span>):</span></span><br><span class="line">    <span class="keyword">for</span> host <span class="keyword">in</span> host_list:</span><br><span class="line">        transport = paramiko.Transport((host[<span class="string">&#x27;hostname&#x27;</span>], <span class="number">22</span>))</span><br><span class="line">        transport.connect(username=host[<span class="string">&#x27;username&#x27;</span>], password=host[<span class="string">&#x27;password&#x27;</span>])</span><br><span class="line">        sftp = paramiko.SFTPClient.from_transport(transport)</span><br><span class="line">        <span class="comment"># 将/tmp/test.txt 上传至服务器 /data/test.txt</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Sending file [&#123;&#125;] to remote server [&#123;&#125;]&quot;</span>.<span class="built_in">format</span>(local_file_name, host[<span class="string">&#x27;hostname&#x27;</span>]))</span><br><span class="line">        sftp.put(local_file_name, remote_file_name)</span><br><span class="line">        <span class="comment"># 将/data/test.txt 下载到本地 /tmp/a.txt</span></span><br><span class="line">        <span class="comment"># sftp.get(&#x27;/data/test.txt&#x27;, &#x27;/tmp/a.txt&#x27;)</span></span><br><span class="line">        transport.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># senf_file_to_remote_server(&#x27;/home/ykyk/gather_server_info/hostinfo.py&#x27;, &#x27;/root/gather_server_info/hostinfo.py&#x27;)</span></span><br><span class="line">    execute_system_check()</span><br></pre></td></tr></table></figure>

<p>完成</p>
</li>
</ul>

    </div>
    <!--文末结束语-->
    
        <div style="text-align:center;color: #ccc;font-size:24px;"> --- <i class="fas fa-heart"></i> The End --- </div>
    
    <!--页脚广告-->
    
    <v-divider></v-divider>
    
    <div class="post-nav">             
        
            <div class="post-nav-button float-left">
                <v-icon>chevron_left</v-icon>
                <a class="font-weight-bold text-left" href="/2019/04/01/MySQL-%E7%BA%BF%E7%A8%8B%E6%B1%A0Python%E5%AE%9E%E7%8E%B0/">
                    MySQL--线程池Python实现
                </a>
            </div>
              
          
            <div class="post-nav-button float-right">
                <a class="font-weight-bold text-right" href="/2019/03/30/MySQL-%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B/">      
                    MySQL--事务提交流程
                </a>
                <v-icon>chevron_right</v-icon>
            </div>
        
    </div>
</v-card>



        
                            <div id="mobile-footer" class="d-block d-md-none">
                                <v-divider></v-divider>
                                <div id="mobile-footer-content">
                                    <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a> &nbsp; Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
                                    <span> &copy; 2015 - 2021 yhkl</span>
                                </div>
                            </div>                   
                        </v-col>                                            
                    </v-row>
                </v-container>
            </v-content>
        </v-app>
    </div>
    
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script>

<script src="/js/main.js"></script>




    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>





</body>
</html>